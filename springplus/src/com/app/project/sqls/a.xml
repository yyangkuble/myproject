<?xml version="1.0" encoding="UTF-8"?>
<sqls modeName="首页" xmlns="http://www.springmvcplus.com/schema/sql" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  xsi:schemaLocation="http://www.springmvcplus.com/schema/sql sql.xsd">
	<!-- 消息数量 A1-->
	<sql id="notifyCount">
		select count(id) as notifyCount from NotifyMessage where toUserId=#{userId} and isread = 0
	</sql>
	<!-- 今日拜访客户 -->
	<sql id="todayVisitCustom">
		select distinct b.name from usertrip a ,custom b where a.visitCustomId = b.id and a.userId= #{userId} and visitDate = curdate()
	</sql>
	<!-- 小秘书提醒 生日 7天内-->
	<sql id="secretaryRemindBirthay">
		select * from ( select id,name,birthday,datediff(concat(DATE_FORMAT(NOW(), '%Y'),right(birthday,6)),curdate()) as daycount,'1' as remindType  from  custom where userId=#{userId}) aa where daycount < 8
	</sql>
	<!-- 小秘书提醒 车险到期-->
	<sql id="secretaryRemindCar">
		select * from(select id,name,carExpireDate,date_sub(carExpireDate,interval 3 month) as toubaoDate,datediff(curdate(),date_sub(date_sub(carExpireDate,interval 3 month),interval 7 day)) as daycount,'2' as remindType from custom where userId=#{userId}) aa where daycount >=0
	</sql>
	<!-- 小秘书提醒 纪念日-->
	<sql id="secretaryRemindImportanceday">
		select * from (select a.id,a.name,b.day,b.context,datediff(curdate(),concat(DATE_FORMAT(NOW(), '%Y'),right(b.day,6))) as daycount,'3' as remindType from custom a join customimportanceday b on a.id=b.customId where a.userId=#{userId}) aa where daycount<4
	</sql>
	<!-- 建议拜访的客户 -->
	<sql id="proposalVisitCustom">
		<script>
			if(type=='birthay'){
				<!-- 近期生日 -->
				<text>select * from ( select id,name,birthday,datediff(concat(DATE_FORMAT(NOW(), '%Y'),right(birthday,6)),curdate()) as daycount,imgPathSmall from  custom where userId=#{userId}) aa where daycount < 61 and daycount >=0 order by daycount</text>
			}else if(type=='healthy'){
				<!-- 健康需求 -->
				<text>select id,name,age,imgPathSmall from custom where userId=#{userId} and age between 25 and 44 and sex = '女' order by age</text>
			}else if(type=='money'){
				<!-- 理财需求 -->
				<text>select id,name,age,imgPathSmall from custom where userId=#{userId} and age between 40 and 54 order by age</text>
			}else if(type=='family'){
				<!-- 家庭保单需求 -->
				<text>select id,name,age,imgPathSmall from custom where userId=#{userId} and age between 30 and 39 order by age</text>
			}else if(type=='longVisit'){
				<!-- 久未拜访 -->
				<text>select * from (select aa.*,bb.id,bb.name,bb.imgPathSmall,datediff(curdate(),aa.visitTime) as daysnovisit from (select a.visitCustomId,max(a.visitTime) as visittime from usertrip a where userid=#{userId} and a.state in(2,3) group by a.visitCustomId) aa join custom bb on aa.visitCustomId = bb.id) aaa where aaa.daysnovisit > 90 order by aaa.daysnovisit desc</text>
			}else if(type=='custionData'){
				<!-- 资料收集 -->
				<text>select * from custom where birthDay is null or birthDay ='' and userid = #{userId}</text>
			}
		</script>
		
	</sql>
	
</sqls>
